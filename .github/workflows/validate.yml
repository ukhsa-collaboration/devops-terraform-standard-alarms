name: Validate Terraform

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: terraform-validate-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_ACCESS_KEY_ID: test
  AWS_SECRET_ACCESS_KEY: test
  AWS_DEFAULT_REGION: eu-west-2
  TF_PLUGIN_CACHE_DIR: /tmp/terraform-plugin-cache
  TF_IN_AUTOMATION: true

jobs:
  docs:
    name: Terraform formatting
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:

    - name: Check out repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        persist-credentials: false
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update terraform-docs
      run: |
        docker run --rm -v "$PWD":/workdir -w /workdir quay.io/terraform-docs/terraform-docs:latest markdown table --output-file README.md --output-mode inject .

    - name: Verify terraform-docs is up to date
      run: |
        if git diff --quiet README.md; then
          echo "terraform-docs is up to date."
          exit 0
        fi
        echo "terraform-docs is stale; please run terraform-docs locally and commit the changes."
        exit 1
  
  lint:
    name: Terraform formatting
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Create Terraform plugin cache directory
        run: mkdir -p "$TF_PLUGIN_CACHE_DIR"

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Check Terraform formatting
        run: terraform fmt -check -recursive

  validate:
    name: Terraform validate (${{ matrix.directory }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        directory:
          - .
          - examples/basic
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Create Terraform plugin cache directory
        run: mkdir -p "$TF_PLUGIN_CACHE_DIR"

      - name: Cache Terraform providers
        uses: actions/cache@v4
        with:
          path: ${{ env.TF_PLUGIN_CACHE_DIR }}
          key: terraform-providers-${{ runner.os }}
          restore-keys: |
            terraform-providers-${{ runner.os }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        working-directory: ${{ matrix.directory }}
        run: terraform init -backend=false -input=false

      - name: Terraform validate
        working-directory: ${{ matrix.directory }}
        run: terraform validate -no-color

  # Not currently possible due to Github Actions restrictions
  # tflocal:
  #   name: LocalStack integration tests
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   timeout-minutes: 45
  #   strategy:
  #       matrix:
  #         directory:
  #           - .
  #           - examples/basic
  #   steps:
  #     - name: Check out repository
  #       uses: actions/checkout@v6

  #     - name: Start LocalStack
  #       uses: LocalStack/setup-localstack@v0.2.4
  #       with:
  #         image-tag: 'latest'
  #         install-awslocal: 'false'

  #     - name: Create Terraform plugin cache directory
  #       run: mkdir -p "$TF_PLUGIN_CACHE_DIR"

  #     - name: Cache Terraform providers
  #       uses: actions/cache@v4
  #       with:
  #         path: ${{ env.TF_PLUGIN_CACHE_DIR }}
  #         key: terraform-providers-${{ runner.os }}
  #         restore-keys: |
  #           terraform-providers-${{ runner.os }}

  #     - name: Set up Terraform
  #       uses: hashicorp/setup-terraform@v3

  #     - name: Set up Python
  #       uses: actions/setup-python@v6
  #       with:
  #         python-version: '3.11'

  #     - name: Install tflocal
  #       run: pip install --upgrade terraform-local

  #     - name: Validate configuration with tflocal
  #       working-directory: ${{ matrix.directory }}
  #       run: |
  #         tflocal init -input=false -backend=false
  #         tflocal validate
  #         tflocal plan -input=false -out=tfplan
  #         tflocal show tfplan
