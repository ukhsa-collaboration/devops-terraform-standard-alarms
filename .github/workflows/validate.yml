name: Validate Terraform

on:
  pull_request:
  push:
    branches:
    - main

concurrency:
  group: terraform-validate-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_ACCESS_KEY_ID: test
  AWS_SECRET_ACCESS_KEY: test
  AWS_DEFAULT_REGION: eu-west-2
  TF_PLUGIN_CACHE_DIR: /tmp/terraform-plugin-cache
  TF_IN_AUTOMATION: true

jobs:
  docs:
    name: Ensures docs are up-to-date
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Check out repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Install terraform-docs
      run: |
        version=$(curl -s https://api.github.com/repos/terraform-docs/terraform-docs/releases/latest \
          | grep tag_name | cut -d '"' -f 4 | sed 's/v//')
        filename="terraform-docs-v${version}-$(uname | tr '[:upper:]' '[:lower:]')-amd64.tar.gz"

        curl -sSLo terraform-docs.tar.gz \
          "https://github.com/terraform-docs/terraform-docs/releases/download/v${version}/${filename}"

        tar -xzf terraform-docs.tar.gz terraform-docs
        sudo mv terraform-docs /usr/local/bin/
        chmod +x /usr/local/bin/terraform-docs

    - name: Run terraform-docs and check for diffs
      run: |
        terraform-docs markdown table --output-file README.md --output-mode inject .
        if git diff --exit-code -- README.md >/dev/null; then
          echo "terraform-docs output is up to date."
        else
          echo "terraform-docs output is stale. Please run terraform-docs and commit changes."
          git --no-pager diff README.md
          exit 1
        fi


  lint:
    name: Terraform formatting
    runs-on: ubuntu-latest
    steps:
    - name: Check out repository
      uses: actions/checkout@v6

    - name: Create Terraform plugin cache directory
      run: mkdir -p "$TF_PLUGIN_CACHE_DIR"

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Check Terraform formatting
      run: terraform fmt -check -recursive

  validate:
    name: Terraform validate (${{ matrix.directory }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        directory:
        - .
        - examples/basic
    steps:
    - name: Check out repository
      uses: actions/checkout@v6

    - name: Create Terraform plugin cache directory
      run: mkdir -p "$TF_PLUGIN_CACHE_DIR"

    - name: Cache Terraform providers
      uses: actions/cache@v4
      with:
        path: ${{ env.TF_PLUGIN_CACHE_DIR }}
        key: terraform-providers-${{ runner.os }}
        restore-keys: |
          terraform-providers-${{ runner.os }}

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform init
      working-directory: ${{ matrix.directory }}
      run: terraform init -backend=false -input=false

    - name: Terraform validate
      working-directory: ${{ matrix.directory }}
      run: terraform validate -no-color

  # Not currently possible due to Github Actions restrictions
  # tflocal:
  #   name: LocalStack integration tests
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   timeout-minutes: 45
  #   strategy:
  #       matrix:
  #         directory:
  #           - .
  #           - examples/basic
  #   steps:
  #     - name: Check out repository
  #       uses: actions/checkout@v6

  #     - name: Start LocalStack
  #       uses: LocalStack/setup-localstack@v0.2.4
  #       with:
  #         image-tag: 'latest'
  #         install-awslocal: 'false'

  #     - name: Create Terraform plugin cache directory
  #       run: mkdir -p "$TF_PLUGIN_CACHE_DIR"

  #     - name: Cache Terraform providers
  #       uses: actions/cache@v4
  #       with:
  #         path: ${{ env.TF_PLUGIN_CACHE_DIR }}
  #         key: terraform-providers-${{ runner.os }}
  #         restore-keys: |
  #           terraform-providers-${{ runner.os }}

  #     - name: Set up Terraform
  #       uses: hashicorp/setup-terraform@v3

  #     - name: Set up Python
  #       uses: actions/setup-python@v6
  #       with:
  #         python-version: '3.11'

  #     - name: Install tflocal
  #       run: pip install --upgrade terraform-local

  #     - name: Validate configuration with tflocal
  #       working-directory: ${{ matrix.directory }}
  #       run: |
  #         tflocal init -input=false -backend=false
  #         tflocal validate
  #         tflocal plan -input=false -out=tfplan
  #         tflocal show tfplan
